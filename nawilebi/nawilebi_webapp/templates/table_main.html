{% extends "table_base.html" %}

{% block content %}

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <a class="navbar-brand" href="#">Car Parts</a>
  <div class="collapse navbar-collapse">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('manage_users') }}">Add Users</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
      </li>
    </ul>
  </div>
</nav>

<!-- Filter Bar Section -->
<div class="filter-bar mb-3">
  <!-- (Your existing filter bar code) -->
  <div class="row">
    <div class="col-md-4">
      <label for="car_mark_filter">Car Mark:</label>
      <input type="text" id="car_mark_filter" class="form-control" placeholder="Select Car Mark">
    </div>
    <div class="col-md-4">
      <label for="car_model_filter">Car Model:</label>
      <input type="text" id="car_model_filter" class="form-control" placeholder="Select Car Model">
    </div>
    <div class="col-md-4">
      <label for="part_full_name_filter">Part Name:</label>
      <input type="text" id="part_full_name_filter" class="form-control" placeholder="Select Part Name">
    </div>
  </div>
  <div class="row mt-2">
    <div class="col-md-4">
      <label for="year_filter">Year:</label>
      <input type="text" id="year_filter" class="form-control" placeholder="Enter Year">
    </div>
    <div class="col-md-4">
      <label for="price_filter">Price:</label>
      <input type="text" id="price_filter" class="form-control" placeholder="Type a Price">
    </div>
    <div class="col-md-4">
      <label for="in_stock_filter">In Stock:</label>
      <select id="in_stock_filter" class="form-control">
        <option value="">All</option>
        <option value="1">Yes</option>
        <option value="0">No</option>
      </select>
    </div>
  </div>
  <div class="row mt-2">
    <div class="col-md-3 align-self-end">
      <button id="reset_filters" class="btn btn-secondary">Reset Filters</button>
    </div>
  </div>
</div>

<!-- Table Section -->
<table id="data" class="table table-striped">
  <thead>
    <tr>
      <th>Part URL</th>
      <th>Car Mark</th>
      <th>Car Model</th>
      <th>Part Name</th>
      <th>Start Year</th>
      <th>End Year</th>
      <th>Price</th>
      <th>In Stock</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
{% endblock %}

{% block scripts %}
<script>
  $(document).ready(function () {
    var table = $('#data').DataTable({
      scrollY: '400px',  // Fixed height to prevent size changes
      scrollCollapse: true,
      paging: true,
      ajax: {
        url: '/api/data',
        data: function (d) {
          d.car_mark = $('#car_mark_filter').val();
          d.car_model = $('#car_model_filter').val();
          d.part_full_name = $('#part_full_name_filter').val();
          d.year = $('#year_filter').val();
          d.price = $('#price_filter').val();
          d.in_stock = $('#in_stock_filter').val();
        }
      },
      serverSide: true,
      columns: [
        {data: 'part_url', render: function(data, type, row) {
            return '<a href="'+data+'" target="_blank" class="btn btn-primary btn-sm">View Part</a>';
        }},
        {data: 'car_mark'},
        {data: 'car_model'},
        {data: 'part_full_name'},
        {data: 'start_year'},
        {data: 'end_year'},
        {data: 'price'},
        {data: 'in_stock', render: function(data, type, row) {
            return data ? 'Yes' : 'No';
        }}
      ],
      order: []  // Disable default sorting
    });

    // Function to initialize autocomplete with preloaded options
    function initializeAutocomplete(selector, url, extraData) {
      $(selector).autocomplete({
        source: function(request, response) {
          var data = {search: request.term};
          if (extraData) {
            data = Object.assign(data, extraData());
          }
          $.ajax({
            url: url,
            data: data,
            success: function(data) {
              response(data);
            }
          });
        },
        minLength: 0,  // Show all options when the input is focused
        select: function () {
          table.draw(false);
        }
      }).focus(function(){
        // Show the complete list when input is focused
        $(this).autocomplete('search', '');
      });
    }

    // Initialize autocomplete for each filter
    initializeAutocomplete('#car_mark_filter', '/api/filters/car_mark');
    initializeAutocomplete('#car_model_filter', '/api/filters/car_model', function () {
      return {car_mark: $('#car_mark_filter').val()};
    });
    initializeAutocomplete('#part_full_name_filter', '/api/filters/part_full_name', function () {
      return {
        car_mark: $('#car_mark_filter').val(),
        car_model: $('#car_model_filter').val()
      };
    });

    // Redraw the table when any filter is changed
    $('#car_mark_filter, #car_model_filter, #part_full_name_filter, #year_filter, #price_filter, #in_stock_filter').on('change input', function () {
      table.draw(false);
    });

    // Reset filters
    $('#reset_filters').click(function () {
      // Reset all filter values
      $('#car_mark_filter, #car_model_filter, #part_full_name_filter, #year_filter, #price_filter, #in_stock_filter').val('');
      table.draw(false);
    });
  });
</script>
{% endblock %}
