{% extends "table_base.html" %}

{% block content %}

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <a class="navbar-brand" href="#">ავტო ნაწილები</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" 
          aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('manage_users') }}">მომხმარებლების დამატება</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('logout') }}">გასვლა</a>
      </li>
    </ul>
  </div>
</nav>

<!-- Filter Bar Section -->
<div class="container mt-4">
  <div class="filter-bar mb-3">
    <div class="row">
      <div class="col-md-4">
        <label for="car_mark_filter">ავტო მარკა:</label>
        <input type="text" id="car_mark_filter" class="form-control" placeholder="აირჩიეთ ავტო მარკა">
      </div>
      <div class="col-md-4">
        <label for="car_model_filter">ავტო მოდელი:</label>
        <input type="text" id="car_model_filter" class="form-control" placeholder="აირჩიეთ ავტო მოდელი">
      </div>
      <div class="col-md-4">
        <label for="part_full_name_filter">ნაწილის სახელი:</label>
        <input type="text" id="part_full_name_filter" class="form-control" placeholder="აირჩიეთ ნაწილის სახელი">
      </div>
    </div>
    <div class="row mt-2">
      <div class="col-md-4">
        <label for="year_filter">წელი:</label>
        <input type="number" id="year_filter" class="form-control" placeholder="შეიყვანეთ წელი">
      </div>
      <div class="col-md-4">
        <label for="price_filter">ფასი:</label>
        <input type="number" id="price_filter" class="form-control" placeholder="შეიყვანეთ ფასი">
      </div>
      <div class="col-md-4">
        <label for="in_stock_filter">დაფასება:</label>
        <select id="in_stock_filter" class="form-control">
          <option value="">ყველა</option>
          <option value="1">კი</option>
          <option value="0">არა</option>
        </select>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-md-3 align-self-end">
        <button id="reset_filters" class="btn btn-secondary">ფილტრების გაუქმება</button>
      </div>
    </div>
  </div>

  <!-- Table Section -->
  <table id="data" class="table table-striped table-bordered" style="width:100%">
    <thead>
      <tr>
        <th>ნაწილის URL</th>
        <th>ავტო მარკა</th>
        <th>ავტო მოდელი</th>
        <th>ნაწილის სახელი</th>
        <th>საწყისი წელი</th>
        <th>დასასრული წელი</th>
        <th>ფასი</th>
        <th>დაფასება</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<!-- Include jQuery and jQuery UI for Autocomplete -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js" 
        integrity="sha256-K+ctZQ6Qzj1ZNjBvTnV4gdjFZ0VJraW6fjI3DzPMNJw=" 
        crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js" 
        integrity="sha256-lHB4w6R1X6q/T5hAJX6TV4nQW3k5JGZMlM7pR8C/tQg=" 
        crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

<!-- Include DataTables CSS and JS -->
<link rel="stylesheet" 
      href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

<script>
  $(document).ready(function () {
    // Initialize DataTable with server-side processing
    var table = $('#data').DataTable({
      scrollY: '400px',  // Fixed height to prevent size changes
      scrollCollapse: true,
      paging: true,
      ajax: {
        url: '/api/data',
        data: function (d) {
          d.car_mark = $('#car_mark_filter').val();
          d.car_model = $('#car_model_filter').val();
          d.part_full_name = $('#part_full_name_filter').val();
          d.year = $('#year_filter').val();
          d.price = $('#price_filter').val();
          d.in_stock = $('#in_stock_filter').val();
        }
      },
      serverSide: true,
      processing: true,
      columns: [
        {data: 'part_url', render: function(data, type, row) {
            return '<a href="'+data+'" target="_blank" class="btn btn-primary btn-sm">ნახე ნაწილი</a>';
        }},
        {data: 'car_mark'},
        {data: 'car_model'},
        {data: 'part_full_name'},
        {data: 'start_year'},
        {data: 'end_year'},
        {data: 'price'},
        {data: 'in_stock', render: function(data, type, row) {
            return data ? 'კი' : 'არა';
        }}
      ],
      order: [],  // Disable default sorting
      language: {
        processing: "იტვირთება..."
      }
    });

    // Debounce function to limit the rate of function execution
    function debounce(func, wait, immediate) {
      var timeout;
      return function() {
        var context = this, args = arguments;
        var later = function() {
          timeout = null;
          if (!immediate) func.apply(context, args);
        };
        var callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(context, args);
      };
    };

    // Function to initialize autocomplete with preloaded options
    function initializeAutocomplete(selector, url, extraData) {
      $(selector).autocomplete({
        source: function(request, response) {
          var data = {search: request.term};
          if (extraData) {
            data = Object.assign(data, extraData());
          }
          $.ajax({
            url: url,
            data: data,
            success: function(data) {
              response(data);
            }
          });
        },
        minLength: 0,  // Show all options when the input is focused
        select: function () {
          table.draw(false);
        }
      }).focus(function(){
        // Show the complete list when input is focused
        $(this).autocomplete('search', '');
      });
    }

    // Initialize autocomplete for each filter
    initializeAutocomplete('#car_mark_filter', '/api/filters/car_mark');
    initializeAutocomplete('#car_model_filter', '/api/filters/car_model', function () {
      return {car_mark: $('#car_mark_filter').val()};
    });
    initializeAutocomplete('#part_full_name_filter', '/api/filters/part_full_name', function () {
      return {
        car_mark: $('#car_mark_filter').val(),
        car_model: $('#car_model_filter').val()
      };
    });

    // Debounced redraw function to optimize performance
    var debouncedDraw = debounce(function() {
      table.draw(false);
    }, 300);  // 300 milliseconds delay

    // Redraw the table when any filter is changed (keyup and change events)
    $('#car_mark_filter, #car_model_filter, #part_full_name_filter, #year_filter, #price_filter, #in_stock_filter').on('keyup change', function () {
      debouncedDraw();
    });

    // Reset filters
    $('#reset_filters').click(function () {
      // Reset all filter values
      $('#car_mark_filter, #car_model_filter, #part_full_name_filter, #year_filter, #price_filter, #in_stock_filter').val('');
      table.draw(false);
    });
  });
</script>
{% endblock %}
